@using PanMedix.DTO.Global
@using PanMedix.Enums
@using PanMedix.ViewModels
@using PanMedix.Helpers;

@model PagedResult<GuardianViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewBag.Title = "Upravljanje Starateljima";
    Layout = "_Dashboard";
    var guardians = Model.Items;
    var areGuardiansPresent = guardians.Count > 0;
}

<div class="p-6 space-y-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-cyan-100 p-6 rounded-2xl border border-cyan-200 shadow-sm">
        <div>
            <h1 class="text-3xl font-bold text-cyan-900">Upravljanje Starateljima</h1>
            <p class="text-cyan-700">Pregled, odobravanje i administracija staratelja na platformi</p>
        </div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-cyan-100">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            @if (areGuardiansPresent)
            {
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <div class="relative">
                        <form asp-action="Index" method="GET">
                            <select name="status" onchange="this.form.submit()" class="appearance-none pl-10 pr-10 py-2.5 bg-cyan-50 border border-cyan-200 text-cyan-900 text-sm rounded-xl focus:ring-cyan-500 focus:border-cyan-500 block w-full outline-none">
                                <option value="">Svi staratelji</option>
                                @foreach (GuardianStatus status in Enum.GetValues(typeof(GuardianStatus)))
                                {
                                    if (ViewBag.Status != null && ViewBag.Status.ToString() == status.ToString() && status != GuardianStatus.NotGuardian)
                                    {
                                        <option value="@status" selected>@status.GetDisplayName()</option>
                                    }
                                    else if(status != GuardianStatus.NotGuardian)
                                    {
                                        <option value="@status">@status.GetDisplayName()</option>
                                    }
                                }
                            </select>
                        </form>
                        
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-cyan-600">
                            <i class="fa-solid fa-filter"></i>
                        </div>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-cyan-600">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>

                    <div class="relative">
                        <form asp-action="Index" method="GET">
                            <select name="sort" onchange="this.form.submit()" class="appearance-none pl-10 pr-10 py-2.5 bg-cyan-50 border border-cyan-200 text-cyan-900 text-sm rounded-xl focus:ring-cyan-500 focus:border-cyan-500 block w-full outline-none">
                                @if (ViewBag.Sort is not null)
                                {
                                    @switch (ViewBag.Sort)
                                    {
                                        case "name":
                                            <option selected disabeld hidden>Sortiraj po imenu</option>
                                            break;
                                        case "wards":
                                            <option selected disabeld hidden>Sortiraj po broju štićenika</option>
                                            break;
                                        case "date":
                                            <option selected disabeld hidden>Sortiraj po datumu prijave</option>
                                            break;
                                    }
                                }
                                <option value="name">Sortiraj po imenu</option>
                                <option value="wards">Sortiraj po broju štićenika</option>
                                <option value="date">Sortiraj po datumu prijave</option>
                            </select>
                        </form>
                        
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-cyan-600">
                            <i class="fa-solid fa-sort"></i>
                        </div>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-cyan-600">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
            </div>
            }
            
        </div>

        <div class="overflow-x-auto rounded-xl">
            @if (!areGuardiansPresent)
            {
                <div class="flex flex-col justify-center items-center w-full p-4 gap-2 text-center">
                    <i class="fa-solid fa-ban text-5xl text-red-900"></i>
                    <h1 class="text-4xl font-semibold text-slate-800">Nema rezultata</h1>
                    <p class="text-xl font-semibold text-slate-600">Staratelji sa traženim parametrima nisu pronadjeni</p>
                </div>
            }
            else
            {
                <table class="w-full text-left border-collapse">
                <thead>
                <tr class="bg-cyan-50/50 text-cyan-800 border-b border-cyan-100">
                    <th class="px-6 py-4 font-bold text-sm uppercase tracking-wider">Korisnik</th>
                    <th class="px-6 py-4 font-bold text-sm uppercase tracking-wider text-center">Status</th>
                    <th class="px-6 py-4 font-bold text-sm uppercase tracking-wider text-center">Broj štićenika</th>
                    <th class="px-6 py-4 font-bold text-sm uppercase tracking-wider text-right">Akcije</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-cyan-50">
                @foreach (var guardian in guardians)
                {
                   <tr class="hover:bg-cyan-50/30 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-100 to-cyan-200 flex items-center justify-center text-cyan-700 font-bold shadow-sm overflow-hidden">
                                <img src="https://ui-avatars.com/api/?background=random&name=@(guardian.FirstName)+@(guardian.LastName)" alt="Avatar" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="font-bold text-cyan-900">@guardian.FirstName @guardian.LastName</div>
                                <div class="text-xs text-cyan-600 font-medium">@guardian.Email</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center whitespace-nowrap">
                        @switch (guardian.Status)
                        {
                            case GuardianStatus.Approved:
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold ring-1 ring-inset ring-green-600/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-green-600"></span>
                                    Odobren
                                </span>
                                break;
                            case GuardianStatus.Pending:
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-bold ring-1 ring-inset ring-amber-600/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-amber-600 animate-pulse"></span>
                                    Na čekanju
                                </span>
                                break;
                            case GuardianStatus.Denied:
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold ring-1 ring-inset ring-red-600/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-amber-600 animate-pulse"></span>
                                    Odbijen
                                </span> 
                                break;
                                
                        }
                        
                    </td>
                    <td class="px-6 py-4 text-center whitespace-nowrap font-bold text-cyan-400">
                        @guardian.NumberOfWards
                    </td>
                    <td class="px-6 py-4 text-right whitespace-nowrap">
                        @switch (guardian.Status)
                        {
                            case GuardianStatus.Approved:
                                <button class="p-2 text-cyan-600 hover:bg-cyan-50 rounded-lg transition-colors" title="Detalji">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                break;
                            case GuardianStatus.Pending:
                                <div class="flex justify-end items-center">
                                    <form asp-action="UpdateStatus" method="POST">
                                        <input type="hidden" name="status" value="@GuardianStatus.Approved">
                                        <input type="hidden" name="userId" value="@guardian.Id">
                                        <button class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 text-white text-xs font-bold rounded-lg transition-all shadow-md shadow-cyan-100">
                                            Odobri
                                        </button>
                                    </form>
                                
                                    <form asp-action="UpdateStatus" method="POST">
                                        <input type="hidden" name="status" value="@GuardianStatus.Denied">
                                        <input type="hidden" name="userId" value="@guardian.Id">

                                        <button class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors ml-2" title="Odbij">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    </form>
                                </div>
                                
                                
                                break;
                            case GuardianStatus.Denied:
                                <form asp-action="UpdateStatus" method="POST">
                                    <input type="hidden" name="status" value="@GuardianStatus.NotGuardian">
                                    <input type="hidden" name="userId" value="@guardian.Id">
                                    <button class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg transition-all shadow-md shadow-red-100">
                                        Obriši iz tabele
                                    </button>
                                </form>
                                
                                break;
                        }
                    </td>
                    
                    
                </tr> 
                }

                </tbody>
            </table>
            }
            
        </div>

        @if (areGuardiansPresent)
        {
            <div class="mt-8 flex flex-col md:flex-row items-center justify-between gap-4 border-t border-cyan-50 pt-6">
                <p class="text-sm text-cyan-600">Prikazano @Model.PaginatedCount od @Model.TotalCount staratelja</p>
                @if (Model.TotalPages > 1)
                {
                    <div class="flex gap-2">
                        <form asp-action="Index" method="GET">
                            <input type="hidden" name="page" value="@(Model.Page - 1)">

                            <button type="submit" disabled="@(Model.Page == 1)" class="disabled:pointer-events-none px-4 py-2 border border-cyan-200 rounded-xl text-sm font-semibold text-cyan-700 hover:bg-cyan-50 transition-colors disabled:opacity-50">Prethodna</button>
                        </form>

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <form asp-action="Index" method="GET">
                                <input type="hidden" name="page" value="@i">
                                <button
                                    disabled="@(Model.Page == i)"
                                    type="submit"
                                    class="disabled:opacity-70 disabled:pointer-events-none px-4 py-2 bg-cyan-600 text-white rounded-xl text-sm font-semibold hover:bg-cyan-700 transition-colors shadow-md shadow-cyan-100">
                                    @i
                                </button>
                            </form>

                        }
                        <form asp-action="Index" method="GET">
                            <input type="hidden" name="page" value="@(Model.Page + 1)">

                            <button disabled="@(Model.Page == (int)Model.TotalPages)" class="disabled:opacity-50 disabled:pointer-events-none px-4 py-2 border border-cyan-200 rounded-xl text-sm font-semibold text-cyan-700 hover:bg-cyan-50 transition-colors">Sledeća</button>
                        </form>

                    </div>
                    
                }
                
                
            </div>
        }
        
    </div>
</div>
